<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verified - DieBuddy</title>
    
    <!-- External CSS Files -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/navigation.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">
    <link rel="stylesheet" href="../assets/css/fonts.css">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../assets/images/logo/favicon.png">
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="logo">DieBuddy</div>
            <div class="nav-links">
                <a href="../index.html">Home</a>
                <a href="features.html">Features</a>
                <a href="contact.html">Contact</a>
                <a href="privacy.html">Privacy Policy</a>
            </div>
        </div>
    </nav>

    <!-- Email Verification Content -->
    <div class="page active" style="padding-top: 120px;">
        <div class="container">
            <div class="verification-container">
                <div class="verification-icon" style="font-size: 5rem; color: #4CAF50; margin-bottom: 2rem;">✅</div>
                <h1 style="color: #4CAF50; margin-bottom: 1rem;">Email Verified Successfully!</h1>
                <p style="font-size: 1.3rem; margin-bottom: 3rem; color: #666;">Welcome to DieBuddy! Your email has been verified and your account is ready to use.</p>

                <div class="verification-form">
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 2rem; color: #4CAF50;">🎉</div>
                        <h2 style="color: #4CAF50; margin-bottom: 1rem;">You're All Set!</h2>
                        <p style="margin-bottom: 2rem; color: #666; font-size: 1.1rem;">
                            Your DieBuddy account has been successfully verified. You can now sign in to the app and start tracking your game statistics!
                        </p>
                        
                        <!-- App Launch Buttons -->
                        <div style="margin: 2rem 0;">
                            <button onclick="openDieBuddyApp()" style="background: linear-gradient(45deg, #b22222, #dc143c); color: white; padding: 15px 30px; border: none; border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin: 0.5rem; box-shadow: 0 5px 15px rgba(178, 34, 34, 0.3); transition: transform 0.3s ease;">
                                🚀 Open DieBuddy App
                            </button>
                        </div>
                        
                        <div style="margin: 2rem 0;">
                            <p style="color: #888; font-size: 0.9rem; margin-bottom: 1rem;">
                                Don't have the app installed yet?
                            </p>
                            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                <button onclick="downloadApp('ios')" style="background: #007AFF; color: white; padding: 12px 24px; border: none; border-radius: 25px; font-weight: bold; cursor: pointer; transition: transform 0.3s ease;">
                                    📱 Download for iOS
                                </button>
                                <button onclick="downloadApp('android')" style="background: #34A853; color: white; padding: 12px 24px; border: none; border-radius: 25px; font-weight: bold; cursor: pointer; transition: transform 0.3s ease;">
                                    🤖 Download for Android
                                </button>
                            </div>
                        </div>

                        <!-- Account Details -->
                        <div id="userDetails" style="margin: 2rem 0; padding: 1.5rem; background: #f0f8ff; border-radius: 15px; display: none;">
                            <h4 style="color: #b22222; margin-bottom: 1rem;">Account Details</h4>
                            <div id="userInfo" style="font-size: 0.9rem; color: #666;"></div>
                        </div>

                        <!-- Alternative Actions -->
                        <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #eee;">
                            <p style="color: #666; margin-bottom: 1rem;">Other options:</p>
                            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                <button onclick="window.location.href='../index.html'" style="background: transparent; border: 2px solid #b22222; color: #b22222; padding: 10px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                                    🏠 Back to Home
                                </button>
                                <button onclick="window.location.href='contact.html'" style="background: transparent; border: 2px solid #6c757d; color: #6c757d; padding: 10px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                                    💬 Contact Support
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Next Steps Guide -->
                <div style="margin-top: 3rem; padding: 2rem; background: linear-gradient(135deg, #b22222, #dc143c); color: white; border-radius: 15px; text-align: center;">
                    <h3 style="color: white; margin-bottom: 1rem;">🎮 Ready to Start Gaming?</h3>
                    <p style="margin-bottom: 2rem; color: rgba(255,255,255,0.9);">
                        Now that your account is verified, you can enjoy all of DieBuddy's features!
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0;">
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                            <strong>📊 Track Statistics</strong><br>
                            <small>Record every game and improve</small>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                            <strong>👥 Join Groups</strong><br>
                            <small>Play with friends and compete</small>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                            <strong>🏆 Earn Achievements</strong><br>
                            <small>Unlock rewards as you play</small>
                        </div>
                    </div>
                    
                    <button onclick="openDieBuddyApp()" style="background: white; color: #b22222; padding: 15px 30px; border: none; border-radius: 25px; font-weight: bold; cursor: pointer; font-size: 1.1rem; margin-top: 1rem; transition: transform 0.3s ease;">
                        🎲 Start Playing Now!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
            <div>
                <h4 style="color: #b22222; margin-bottom: 1rem;">DieBuddy</h4>
                <p>Track your games, improve your skills, have more fun!</p>
                <div style="margin-top: 1rem;">
                    <a href="https://gofund.me/655b9f14" target="_blank" style="color: #b22222; margin-right: 1rem;">💖 Support Us</a>
                </div>
            </div>
            
            <div>
                <h4 style="color: #b22222; margin-bottom: 1rem;">Support</h4>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <a href="contact.html">📧 Contact Support</a>
                    <a href="contact.html">❓ Get Help</a>
                    <a href="privacy.html">🔒 Privacy Policy</a>
                </div>
            </div>
            
            <div>
                <h4 style="color: #b22222; margin-bottom: 1rem;">Get Started</h4>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <a href="#" onclick="openDieBuddyApp()">🚀 Open App</a>
                    <a href="features.html">⭐ View Features</a>
                    <a href="../index.html">🏠 Homepage</a>
                </div>
            </div>
        </div>
        
        <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 2rem; text-align: center;">
            <p>&copy; 2025 DieBuddy. All rights reserved.</p>
            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Your gaming journey starts now!</p>
        </div>
    </div>

    <!-- External JavaScript Files -->
    <script src="../assets/js/navigation.js"></script>
    <script src="../assets/js/supabase.js"></script>
    <script src="../assets/js/main.js"></script>
    
    <!-- Enhanced Verification JavaScript -->
    <script>
        // =====================================
        // DIEBUDDY EMAIL VERIFICATION SUCCESS PAGE
        // =====================================

        console.log('🎉 DieBuddy verification success page loaded');

        // Supabase Configuration
        const SUPABASE_URL = 'https://kamqpgsrxhxuxsvccrra.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImthbXFwZ3NyeGh4dXhzdmNjcnJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyMzM0NTAsImV4cCI6MjA1OTgwOTQ1MH0.rT44_bJTOnOz_pdrOT7o7X_Y3fEPhiB1jzjmLetGYyc';

        // Initialize Supabase
        let supabaseWeb;
        try {
            if (typeof window !== 'undefined' && window.supabase) {
                supabaseWeb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('✅ Supabase initialized successfully');
            }
        } catch (error) {
            console.error('❌ Failed to initialize Supabase:', error);
        }

        // =====================================
        // APP OPENING FUNCTIONS
        // =====================================

        function openDieBuddyApp() {
            // Try multiple methods to open the app
            const appSchemes = [
                'diebuddy://',           // Custom URL scheme
                'diebuddy://verified',   // With verification parameter
                'diebuddy://home',       // Direct to home screen
            ];

            let attemptCount = 0;
            
            function tryOpenApp() {
                if (attemptCount < appSchemes.length) {
                    const scheme = appSchemes[attemptCount];
                    console.log(`Attempting to open app with scheme: ${scheme}`);
                    
                    // Create a hidden iframe to trigger the app
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = scheme;
                    document.body.appendChild(iframe);
                    
                    // Remove iframe after attempt
                    setTimeout(() => {
                        document.body.removeChild(iframe);
                    }, 1000);
                    
                    attemptCount++;
                    
                    // Try next scheme if this one fails
                    setTimeout(() => {
                        if (attemptCount < appSchemes.length) {
                            tryOpenApp();
                        } else {
                            // All schemes failed, show fallback options
                            showAppNotFoundDialog();
                        }
                    }, 2000);
                } else {
                    showAppNotFoundDialog();
                }
            }

            // Start the attempt
            tryOpenApp();

            // Also try the universal link approach
            setTimeout(() => {
                window.location.href = 'diebuddy://verified';
            }, 500);
        }

        function showAppNotFoundDialog() {
            const dialog = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                    <div style="background: white; padding: 2rem; border-radius: 15px; max-width: 400px; text-align: center; margin: 1rem;" onclick="event.stopPropagation()">
                        <h3 style="color: #b22222; margin-bottom: 1rem;">📱 App Not Found</h3>
                        <p style="margin-bottom: 2rem; color: #666;">
                            It looks like you don't have the DieBuddy app installed yet, or it couldn't be opened automatically.
                        </p>
                        <div style="margin-bottom: 2rem;">
                            <button onclick="downloadApp('ios')" style="background: #007AFF; color: white; padding: 12px 24px; border: none; border-radius: 25px; font-weight: bold; cursor: pointer; margin: 0.5rem; transition: transform 0.3s ease;">
                                📱 Download for iOS
                            </button>
                            <br>
                            <button onclick="downloadApp('android')" style="background: #34A853; color: white; padding: 12px 24px; border: none; border-radius: 25px; font-weight: bold; cursor: pointer; margin: 0.5rem; transition: transform 0.3s ease;">
                                🤖 Download for Android
                            </button>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', dialog);
        }

        function downloadApp(platform) {
            if (platform === 'ios') {
                // Replace with your actual App Store URL when available
                alert('🍎 iOS app coming soon! We\'ll notify you when it\'s available on the App Store.');
                // window.open('https://apps.apple.com/app/diebuddy/idXXXXXXXXX', '_blank');
            } else if (platform === 'android') {
                // Replace with your actual Google Play URL when available
                alert('🤖 Android app coming soon! We\'ll notify you when it\'s available on Google Play.');
                // window.open('https://play.google.com/store/apps/details?id=com.diebuddy.app', '_blank');
            }
        }

        // =====================================
        // VERIFICATION TOKEN PROCESSING
        // =====================================

        async function processVerificationTokens() {
            const urlParams = new URLSearchParams(window.location.search);
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            
            const accessToken = urlParams.get('access_token') || hashParams.get('access_token');
            const refreshToken = urlParams.get('refresh_token') || hashParams.get('refresh_token');
            
            if (accessToken && refreshToken && supabaseWeb) {
                try {
                    const { data, error } = await supabaseWeb.auth.setSession({
                        access_token: accessToken,
                        refresh_token: refreshToken
                    });
                    
                    if (data.user && !error) {
                        console.log('✅ User verified:', data.user.email);
                        
                        // Show user details
                        const userDetails = document.getElementById('userDetails');
                        const userInfo = document.getElementById('userInfo');
                        
                        if (userDetails && userInfo) {
                            userInfo.innerHTML = `
                                <strong>Email:</strong> ${data.user.email}<br>
                                <strong>User ID:</strong> ${data.user.id}<br>
                                <strong>Verified:</strong> ${data.user.email_confirmed_at ? '✅ Yes' : '❌ No'}<br>
                                <strong>Created:</strong> ${new Date(data.user.created_at).toLocaleDateString()}
                            `;
                            userDetails.style.display = 'block';
                        }
                        
                        // Update database
                        try {
                            await updateEmailVerificationStatus(data.user.id);
                        } catch (dbError) {
                            console.warn('Database update failed:', dbError);
                        }
                        
                        // Clean up URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } catch (error) {
                    console.error('Session setup failed:', error);
                }
            }
        }

        async function updateEmailVerificationStatus(userId) {
            try {
                const { error } = await supabaseWeb
                    .from('players')
                    .update({ email_verified: true })
                    .eq('user_id', userId);

                if (error) {
                    console.error('Database update error:', error);
                } else {
                    console.log('✅ Database updated successfully');
                }
            } catch (error) {
                console.error('Database update failed:', error);
            }
        }

        // =====================================
        // INITIALIZATION
        // =====================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Verification success page initializing...');
            
            // Process any verification tokens in the URL
            processVerificationTokens();
            
            // Add button hover effects
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px) scale(1.02)';
                });
                
                button.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });

            // Add celebration animation
            setTimeout(() => {
                createCelebrationEffect();
            }, 500);
        });

        // =====================================
        // CELEBRATION EFFECTS
        // =====================================

        function createCelebrationEffect() {
            // Create confetti-like effect
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    createConfetti();
                }, i * 100);
            }
        }

        function createConfetti() {
            const colors = ['#b22222', '#4CAF50', '#2196F3', '#FF9800', '#9C27B0'];
            const confetti = document.createElement('div');
            
            confetti.style.cssText = `
                position: fixed;
                width: 10px;
                height: 10px;
                background: ${colors[Math.floor(Math.random() * colors.length)]};
                left: ${Math.random() * 100}vw;
                top: -10px;
                border-radius: 50%;
                z-index: 1000;
                pointer-events: none;
                animation: confettiFall 3s linear forwards;
            `;
            
            document.body.appendChild(confetti);
            
            setTimeout(() => {
                confetti.remove();
            }, 3000);
        }

        // Add confetti animation CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes confettiFall {
                to {
                    transform: translateY(100vh) rotate(360deg);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // Make functions globally accessible
        window.openDieBuddyApp = openDieBuddyApp;
        window.downloadApp = downloadApp;

        console.log('✅ Verification success page ready');
    </script>
</body>
</html>
